@Library("jenkins-pipeline-workshop-library") _
pipeline
{
    options {
      buildDiscarder(logRotator(numToKeepStr: '5'))
    }
      agent {
      node {
        label 'generic'
        }
    }
    environment
    {
        VERSION   = 'latest'
        PROJECT   = 'shelleg/gitbook'
        IMAGE     = "${PROJECT}/${VERSION}:latest"
    }
    stages
    {
        stage('Build preparations')
        {
            steps
            {
                script
                {
                    setup()
                }
            }
        }
    stage('Docker build') {
      steps {
          script {
                  dockerBuild()
      		        }
	          }
    }
    stage('Publish') {
      steps {
          script {
              docker.withRegistry("https://registry.hub.docker.com", "dockerHub"){
                	// version eq latest git tag
                	docker.image("$IMAGE").push()
                	// override the latest tag
                	docker.image("$IMAGE_LATEST").push()
             }
          }
      }
    }
  }
}
